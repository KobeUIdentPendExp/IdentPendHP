<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロボット制御実験 環境構築ガイド (macOS版)</title> <style>
        /* Reusing styles */
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; line-height: 1.7; padding: 20px; background-color: #f9f9f9; }
        .guide-container { max-width: 900px; margin: auto; background-color: #fff; padding: 30px 40px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .section { border: 1px solid #e0e0e0; background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 5px; }
        .section h3 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 8px; color: #0056b3; }
        .step { background-color: #f8f9fa; border: 1px solid #ced4da; padding: 10px 15px; margin: 10px 0; border-radius: 4px; }
        .confirmation { background-color: #e6fff2; border: 1px solid #b3ffcc; color: #00642e; padding: 10px 15px; margin: 10px 0; border-radius: 4px; } /* Verification green */
        .warning { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px 15px; margin: 10px 0; border-radius: 4px; } /* Warning yellow */
        .step ul, .step ol { margin-top: 5px; margin-bottom: 5px; padding-left: 25px; }
        .step li { margin-bottom: 5px; }
        .note { font-size: 0.9em; color: #555; margin-top: 10px; }
        .code { font-family: 'Courier New', Courier, monospace; background-color: #e9ecef; padding: 2px 5px; border-radius: 3px; color: #c7254e; font-size: 0.95em; }
        .command { font-family: 'Courier New', Courier, monospace; background-color: #212529; color: #f8f9fa; padding: 10px 15px; margin: 10px 0; border-radius: 4px; display: block; white-space: pre; } /* Command style */
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
    </head>
<body>

<div class="guide-container">
    <h2>ロボット制御実験 環境構築ガイド (macOS版)</h2> <p class="note">このガイドは、macOS上でシステム同定から強化学習までの全実験に必要なソフトウェア環境を構築する手順を説明します。主な構成要素は Webots シミュレータと Anaconda (Python) です。</p>

    <div class="section" id="webots-install">
        <h3>1. Webots シミュレータのインストール</h3>
        <p>主に強化学習の実験で使用するロボットシミュレータ Webots をインストールします。</p>
        <div class="step">
            <strong>ダウンロード:</strong>
            <ul>
                <li><a href="https://cyberbotics.com/#download" target="_blank" rel="noopener noreferrer">Webots 公式サイト</a>のダウンロードセクションへ進みます。</li>
                <li>macOS に対応したインストーラー (<span class="code">.dmg</span> ファイル) をダウンロードします。</li>
                <!-- <li class="note">ご自身のMacがAppleシリコン (M1/M2/M3など) かIntelかを確認し、対応するインストーラーを選択してください（サイトが自動判別する場合もあります）。</li> -->
            </ul>
        </div>
        <div class="step">
            <strong>インストール:</strong>
            <ul>
                <li>ダウンロードした <span class="code">.dmg</span> ファイルを開き、中の <span class="code">Webots</span> アプリケーションアイコンを「アプリケーション (<span class="code">Applications</span>)」フォルダにドラッグ＆ドロップします。</li>
                <li>インストール後、初回起動時にセキュリティに関する確認ダイアログが表示される場合があります。指示に従って許可してください。</li>
            </ul>
        </div>
        <div class="confirmation">
            <strong>確認:</strong> インストール後、「アプリケーション」フォルダから Webots アプリケーションを起動し、サンプルワールドなどが開けることを確認してください。
        </div>
        <div class="section" id="webots-install">
            <h3>1. Webots シミュレータのインストール</h3>
            <p>主に強化学習の実験で使用するロボットシミュレータ Webots をインストールします。</p>
            <div class="step">
                <strong>ダウンロード:</strong>
                <ul>
                    <li><a href="https://cyberbotics.com/#download" target="_blank" rel="noopener noreferrer">Webots 公式サイト</a>のダウンロードセクションへ進みます。</li>
                    <li>macOS に対応したインストーラー (<span class="code">.dmg</span> ファイル) をダウンロードします。</li>
                     <li class="note">ご自身のMacがAppleシリコン (M1/M2/M3など) かIntelかを確認し、対応するインストーラーを選択してください（サイトが自動判別する場合もあります）。</li>
                </ul>
            </div>
            <div class="step">
                <strong>インストール:</strong>
                <ol>
                    <li><strong>ディスクイメージを開く試行:</strong> ダウンロードした <span class="code">.dmg</span> ファイルをダブルクリックして開こうとします。</li>
                    <li class="warning">
                        <strong>【セキュリティ警告が表示された場合の対処法】</strong><br>
                        macOS のセキュリティ機能により、以下のような警告が表示されて <span class="code">.dmg</span> ファイルが開けない場合があります。（開発元が未確認などの理由）
                        <div style="text-align: center; margin-top: 10px; margin-bottom: 10px;">
                            <img src="webotsMacSecAlert.png" alt="macOSセキュリティ警告の例：dmgファイルが開けない"
                                 style="max-width: 60%; height: auto; border: 1px solid #ccc; display: block; margin-left: auto; margin-right: auto;">
                             <p class="note" style="margin-top: 5px;">(図：セキュリティ警告の例)</p>
                        </div>
                        この警告ダイアログ自体には「開く」ボタンがありません。「ゴミ箱に入れる」は**クリックせず**、以下の手順を実行してください:
                        <ol style="list-style-type: lower-alpha;">
                            <li>メニューから「**システム設定**」を開きます。</li>
                            <li>左側のメニューで「**プライバシーとセキュリティ**」を選択します。</li>
                            <li>右側を下にスクロールし、「**セキュリティ**」セクションを探します。</li>
                            <li>「"webots-R....dmg"はブロックされました。開発元を確認できないため開けません。」のようなメッセージの横（または下）に表示されている**「このまま開く」**ボタンをクリックします。（管理者パスワードの入力が必要な場合があります）</li>
                            <li><span class="confirmation">「このまま開く」をクリックした後、**もう一度 Finder で .dmg ファイルをダブルクリック**します。今度はディスクイメージがマウントされ、中身が表示されるはずです。</span></li>
                        </ol>
                        <p class="note" style="margin-top: 15px;">以下のGIFは、このセキュリティ警告に対処し、<span class="code">.dmg</span>ファイルを開く手順を示しています:</p>
                        <div style="text-align: center; margin-top: 10px; margin-bottom: 10px;">
                            <img src="webotsMacinstallerOpen.gif" alt="セキュリティ警告を解除してdmgを開く手順のGIF"
                                 style="max-width: 100%; height: auto; border: 1px solid #ccc; display: block; margin-left: auto; margin-right: auto;">
                        </div>
                    </li>
                    <li><strong>アプリケーションのコピー:</strong> <span class="code">.dmg</span> ファイルが正常に開き、中のファイルが表示されたら、<span class="code">Webots</span> アプリケーションのアイコンを、同じウィンドウ内にある「アプリケーション (<span class="code">Applications</span>)」フォルダのエイリアス（またはFinderのサイドバーにある「アプリケーション」フォルダ）にドラッグ＆ドロップしてコピーします。</li>
                    <li><strong>ディスクイメージの取り出し (推奨):</strong> コピーが完了したら、デスクトップまたはFinderのサイドバーに表示されている Webots のディスクイメージアイコンを右クリック（またはControl+クリック）し、「"Webots"を取り出す」を選択してアンマウント（取り出し）します。</li>
                </ol>
            </div>
            <div class="confirmation">
                <strong>確認:</strong> 「アプリケーション」フォルダを開き、コピーされた <span class="code">Webots</span> アプリケーションがあることを確認してください。ダブルクリックして起動し、サンプルワールドなどが開けることを確認してください。（アプリの初回起動時に、別の種類のセキュリティ確認ダイアログが表示されることもあります。その場合は以下の操作手順を参照してください。）
            </div>
            <div style="text-align: center; margin-top: 10px; margin-bottom: 10px;">
                <img src="webots_pre.gif" alt="セキュリティ警告を解除してWebotsを開く手順のGIF"
                     style="max-width: 100%; height: auto; border: 1px solid #ccc; display: block; margin-left: auto; margin-right: auto;">
            </div>
        </div>
    </div>
<!-- 
    <div class="section" id="anaconda-install">
        <h3>2. Anaconda (Python 環境) のインストールと設定</h3>
        <p>全ての実験で使用する Python スクリプトを実行するために Anaconda を使用します。（すでに Anaconda または Miniconda がインストール済みの場合は、このセクションの【専用 Conda 環境の作成】から進んでください）</p>
        <div class="step">
            <strong>ダウンロード (未インストールの場合):</strong>
            <ul>
                <li><a href="https://www.anaconda.com/download" target="_blank" rel="noopener noreferrer">Anaconda Distribution 公式サイト</a>にアクセスします。</li>
                <li>macOS 用のインストーラー (<span class="code">.pkg</span> ファイル) をダウンロードします。
                    <span class="note">ご自身のMacに合ったインストーラー (Apple Silicon または Intel) を選択してください。</span>
                </li>
            </ul>
        </div>
        <div class="step">
            <strong>インストール (未インストールの場合):</strong>
            <ul>
                <li>ダウンロードした <span class="code">.pkg</span> ファイルをダブルクリックしてインストーラーを起動します。</li>
                <li>画面の指示に従ってインストールを進めます。（「続ける」「同意する」「インストール」をクリック。通常はデフォルト設定でOK）</li>
                <li>途中で Mac のログインパスワードの入力を求められる場合があります。</li>
                <li>インストール完了後、ターミナルを再起動すると <span class="code">conda</span> コマンドが利用可能になります。</li>
            </ul>
        </div>
        <div class="step">
             <strong>インストールの確認 (ターミナル):</strong>
            <ol>
                <li>macOS の「ターミナル.app」を起動します。</li>
                <li>以下のコマンドを実行し、conda のバージョンが表示されるか確認します:
                    <code class="command">conda --version</code>
                </li>
                 <li>ターミナルのプロンプトの先頭に <span class="code">(base)</span> と表示されているか確認します。（表示されていればOK）</li>
            </ol>
             <div class="confirmation">
                <p class="note">以下の図は、ターミナルで <code class="code">conda env list</code> コマンドが成功し、<code class="code">(base)</code> 環境がアクティブになっている状態の例です。</p>
                 <div style="text-align: center; margin-top: 10px; margin-bottom: 10px;">
                     <img src="image_928040.png" alt="ターミナルで conda env list を実行した結果のスクリーンショット"
                          style="max-width: 80%; height: auto; border: 1px solid #ccc; display: block; margin-left: auto; margin-right: auto;">
                 </div>
             </div>
        </div>
        <div class="step task">
            <strong>【推奨】専用 Conda 環境の作成 (<span class="code">control_lab</span>):</strong>
            <p>実験に必要なライブラリを他の Python プロジェクトと分離するために、専用の環境を作成します。</p>
            <ol>
                <li>**ターミナル** を開きます。</li>
                <li>以下のコマンドを実行して、<span class="code">control_lab</span> という名前で Python 3.9 の環境を作成します:
                    <code class="command">conda create --name control_lab python=3.9</code>
                    (確認プロンプト <code class="code">Proceed ([y]/n)?</code> が出たら <code class="code">y</code> を入力して Enter)
                </li>
                <li>作成した環境を有効化（アクティベート）します:
                    <code class="command">conda activate control_lab</code>
                </li>
            </ol>
             <div class="confirmation">
                <p>環境の有効化に成功すると、ターミナルのプロンプトの先頭表示が <span class="code">(base)</span> から <span class="code">(control_lab)</span> に変わります。</p>
                </div>
             <p class="note">以降の Python パッケージのインストールは、必ずこの <span class="code">control_lab</span> 環境が**アクティブな状態**で行ってください。</p>
       </div>
    </div> -->

    <div class="section" id="pip-install">
        <h3>2. 必要な Python パッケージのインストール</h3>
        <p>実験で使用するライブラリを <span class="code">control_lab</span> 環境にインストールします。</p>
        <div class="step task">
            <strong>【パッケージのインストール】</strong>
            <ol>
                <li>**ターミナル** を開き、**必ず <span class="code">control_lab</span> 環境を有効化**してください (まだ有効でない場合):
                    <code class="command">conda activate control_lab</code>
                    (プロンプトが <span class="code">(control_lab)</span> になっていることを確認)
                </li>
                <li>以下のコマンドを実行して、基本的な科学計算ライブラリをインストールします:
                    <code class="command">conda install numpy scipy matplotlib</code>
                    (確認プロンプトが出たら <code class="code">y</code> を入力)
                </li>
                 <li>次に、強化学習とハードウェア通信に必要なライブラリを <span class="code">pip</span> を使ってインストールします:
                    <code class="command">pip install gymnasium stable-baselines3 torch torchvision torchaudio hidapi</code>
                     <!-- <span class="note">(<span class="code">stable-baselines3</span> は PyTorch など追加の依存関係も含めてインストールします。もし PyTorch のインストールで問題が出る場合は、<a href="https://pytorch.org/" target="_blank" rel="noopener noreferrer">PyTorch 公式サイト</a> の指示に従って別途インストールを試みてください。)</span><br>
                    <span class="note">(<span class="code">hidapi</span> のインストールでエラーが出る場合は、エラーメッセージを記録して教員/TAに相談してください。)</span> </li> -->
            </ol>
        </div>
    </div>

     <div class="section" id="verification">
        <h3>3. 環境構築の最終確認</h3>
        <div class="step">
             <ol>
                <li>**ターミナル** で、<span class="code">control_lab</span> 環境がアクティブなことを確認します (<span class="code">(control_lab)</span> が先頭に表示)。</li>
                <li>Python のバージョンを確認します: <code class="command">python --version</code> (3.9.x が表示されるはず)</li>
                <li>インストールされた主要なパッケージを確認します (一部):
                    <code class="command">conda list '(numpy|matplotlib|scipy|gymnasium|stable-baselines3|torch|hidapi)'</code>
                    (リストに表示され、バージョン情報が出ていれば OK。pipで入れたものは <code class="code">pip list</code> でも確認可)
                </li>
                <li>Python インタプリタを起動し (<span class="code">python</span> と入力)、ライブラリが import できるか試します:
                    <code class="command">import numpy
import matplotlib
import scipy
import gymnasium
import stable_baselines3
import torch
import hid
exit()</code>
                    (エラーなくプロンプト <code class="code">>>></code> に戻り、<code class="code">exit()</code> で終了できれば成功)
                </li>
                 <li>「アプリケーション」フォルダから Webots アプリケーションを起動できることを確認します。（この時点ではまだPython連携設定はしていません）</li>
            </ol>
        </div>
         <div class="confirmation">
             <strong>【一旦完了】</strong> 上記の確認が全て問題なければ、ソフトウェアのインストールと基本的なPython環境の準備は完了です。次に進んでください。
        </div>
    </div>

    <div class="section" id="webots-python-config">
        <h3>4. Webots と Anaconda Python 環境の連携設定 (macOS)</h3>
        <p class="warning">【macOS ユーザーへの重要注意】Webots から <span class="code">control_lab</span> 環境の Python ライブラリ（特に Stable Baselines3 など）を利用するには、特別な設定が必要です。以下のいずれかの方法を行いますが、**方法2（ターミナルからの起動）を強く推奨します**。</p>

        <!-- <h4>手順1：Webots 環境設定で Python パスを指定 (動作しない可能性が高い)</h4>
        <div class="step warning">
            <p>この方法は、特に Conda 環境を使用する場合、macOS では正常に動作しないことが報告されています。Webots が正しいライブラリを見つけられない可能性があります。もし問題が発生した場合は、以下の「方法2」を試してください。</p>
            <ol>
                <li><strong><span class="code">control_lab</span> 環境の Python パスを確認する:</strong>
                    <ul>
                        <li>ターミナルを開き、<span class="code">control_lab</span> 環境を有効化します: <code class="command">conda activate control_lab</code></li>
                        <li>以下のコマンドを実行して、Python 実行ファイルのフルパスを調べ、コピーします:
                             <code class="command">which python</code>
                             (例: <code class="code">/Users/yourname/anaconda3/envs/control_lab/bin/python</code>)
                        </li>
                     </ul>
                </li>
                <li><strong>Webots の設定を変更する:</strong>
                     <ul>
                        <li>Webots アプリケーションを（通常の方法で）起動します。</li>
                        {/* Corrected menu path based on user snippet */}
                        <li>メニューバーから <span class="code">Webots</span> -> <span class="code">Preferences...</span> を選択。</li>
                        <li><span class="code">General</span> タブの <span class="code">Python command</span> フィールドに、上でコピーしたフルパスを貼り付けます。</li>
                         {/* Changed "OK or Apply" to just "OK" based on user snippet */}
                        <li><span class="code">OK</span> をクリックして保存し、一度 Webots を**終了**します。</li>
                     </ul>
                     <div style="text-align: center; margin-top: 15px; margin-bottom: 10px;">
                         {/* Updated GIF filename and style based on user snippet */}
                         <img src="webotsPythonEnv.gif"
                              alt="Webots PreferencesでPythonコマンドのパスを設定する手順のGIFアニメーション"
                              style="max-width: 100%; height: auto; border: 1px solid #ccc; display: block; margin-left: auto; margin-right: auto;">
                         <p class="note" style="margin-top: 5px;">(図：Webots 設定画面での Python パス設定手順)</p>
                     </div>
                 </li>
            </ol>
        </div> -->

        <h4>【macOS推奨】ターミナルから Webots を起動する (連携を有効にするため)</h4>
        <div class="step task">

            <p class="warning">macOS で Webots を通常起動（アプリケーションフォルダや Dock から起動）すると、設定した Conda 環境 (<span class="code">control_lab</span>) が**正しく認識・利用されず**、コントローラ実行時にライブラリが見つからないエラーが発生することがあります（理由は定かではありませんが、よく報告される現象です）。</p>
            <p>この問題を回避し、設定した <span class="code">control_lab</span> 環境とライブラリを Webots に確実に認識・利用させるためには、以下の手順で**ターミナルから Webots を起動する必要があります**。</p>
            <ol>
                <li><strong>ターミナルを開く:</strong> macOS のターミナル.app を起動します。</li>
                <li><strong>Conda 環境を有効化:</strong> 以下のコマンドで <span class="code">control_lab</span> 環境を有効化します。
                    <code class="command">conda activate control_lab</code>
                    <br>(プロンプトの先頭が <span class="code">(control_lab)</span> になっていることを確認)
                </li>
                <li><strong>Webots をターミナルから起動:</strong> **環境を有効化した、その同じターミナルウィンドウで**、以下のコマンドを実行して Webots を起動します。
                    <code class="command">/Applications/Webots.app/Contents/MacOS/webots</code>
                    <span class="note">上記は標準的なインストールパスです。もし異なる場所にインストールした場合や、バージョンによってパスが違う場合は、実際のパスに調整してください (Tabキー補完が使えるかもしれません)。<br>
                    このようにターミナル経由で起動することで、Webots は <span class="code">control_lab</span> 環境の Python 及びインストールされたライブラリ（numpy, stable-baselines3, torch, hidapi 等）を正しく見つけて使用することができます。（Preferences の設定がこの方法で初めて有効になると考えられます。）</span>
                 </li>
                 <li class="note">毎回このコマンドを打つのが面倒な場合は、このコマンドへのエイリアスを作成したり、PATH を通したりする方法もありますが、まずはこの直接的な方法で動作を確認してください。（詳細は下の【任意】設定を参照）</li>
                 <img src="webotsTerminal.gif"
                 alt="Webotsはタミナールから起動のGIFアニメーション"
                 style="max-width: 100%; height: auto; border: 1px solid #ccc; display: block; margin-left: auto; margin-right: auto;">
            <p class="note" style="margin-top: 5px;">(図：Webots Webotsはタミナールから起動)</p>
            </ol>
        </div>

        <h4>【任意】Webots 起動コマンドの簡略化</h4>

        <div class="step note" style="margin-top: 20px; background-color: #f0f0f0;">
            <!-- <h5 style="margin-top:0; border-bottom: 1px solid #ccc; padding-bottom: 5px;">【任意】Webots 起動コマンドの簡略化</h5> -->
            <p>毎回ターミナルで <code class="code">/Applications/Webots.app/Contents/MacOS/webots</code> と入力するのは少し長いと感じるかもしれません。以下は、単に <code class="code">webots</code> と入力するだけで起動できるようにするための、**任意の設定**です（必須ではありません）。</p>

            <p><strong>エイリアス (alias) を設定する</strong></p>
            <p>エイリアスは、長いコマンドに短い別名を付ける機能です。以下のコマンドをターミナルで実行すると、<code class="code">webots</code> という名前でフルパスのコマンドを実行できるようになります。(macOSの標準シェルzshの場合)</p>
            <code class="command">echo 'export PATH="/Applications/Webots.app/Contents/MacOS:$PATH"' >> ~/.zshrc</code>

            {/* Added Troubleshooting Note for Permission Denied */}
            <p class="note" style="margin-top: 5px; margin-bottom: 10px;">
                <strong style="color: #856404;">【エラーが出る場合】</strong> もし上記のコマンド実行時に <code class="code">permission denied</code> (権限拒否) エラーが出た場合は、方法 A と同様に <code class="code">~/.zshrc</code> ファイルの権限を確認・修正してください。<br/>
                <code class="command">ls -l ~/.zshrc</code> で確認し、必要に応じて <code class="command">sudo chown $(whoami) ~/.zshrc</code>  を実行してから、再度上記の <code class="code">echo ...</code> コマンドを実行してください。
            </p>

            <p>同様に、設定を反映させるにはターミナルを再起動するか <code class="command">source ~/.zshrc</code> を実行してください。その後は <code class="code">conda activate control_lab</code> した後に <code class="command">webots</code> と入力するだけで起動できます。</p>

            <p class="warning" style="margin-top: 15px;"><strong>注意:</strong></p>
            <ul>
                <li>これらの設定は任意であり、利便性のためのものです。設定しなくても、フルパスでコマンドを実行すれば問題ありません。</li>
                <li><code class="code">~/.zshrc</code> は zsh 用の設定ファイルです。もし bash など他のシェルをお使いの場合は、対応する設定ファイル（例: <code class="code">~/.bash_profile</code>）に追記してください。</li>
                <li>設定ファイルの編集は慎重に行ってください。</li>
                <li>**重要:** これらの設定を行っても、Webots を起動する前に <code class="command">conda activate control_lab</code> を実行して環境を有効化するステップは依然として**必要**です。エイリアスやPATH設定は、Webotsの実行ファイルを見つけやすくするだけで、Conda環境を自動で有効化するわけではありません。</li>
            </ul>
        </div>
        <div class="confirmation">
             <strong>【連携のポイント】</strong> 実験で Python コントローラを使用する際は、**必ずこの手順2の方法（ターミナルで <span class="code">control_lab</span> を有効化 → 同じターミナルから Webots を起動）で Webots を起動する**ようにしてください。これにより、設定した Python 環境が Webots 上で正しく機能します。
        </div>
    </div>
    <div class="section" id="integration-test">
        <h3>5. 最終動作確認: Webots と Python 環境の連携テスト (macOS)</h3>
        <p>このセクションでは、Webots が正しく設定・起動され（特にセクション4の手順に従ってターミナルから起動され）、作成した Conda 環境 (<code class="code">control_lab</code>) を認識し、その環境にインストールされた Python パッケージ (numpy, matplotlib, scipy, gymnasium, stable-baselines3, torch) を Webots のコントローラースクリプト内から正常に import できるかを最終確認します。</p>
        <p class="warning">【重要前提】このテストを行う前に、必ず<a href="#webots-python-config">セクション4</a>の【macOS推奨】の手順に従い、<strong>ターミナルで <code class="code">control_lab</code> 環境を有効化してから、そのターミナル経由で Webots を起動していること</strong>を確認してください。また、念のため Webots の Preferences で Python パスが正しく <code class="code">control_lab</code> 環境の <code class="code">python</code> 実行ファイルを指しているかも確認しておくと良いでしょう。</p>

        <div class="step task">
            <strong>Step 1: テスト用 Python コードの準備</strong>
            <ol>
                <li>以下の折りたたみ部分を展開し、テスト用コード全文をコピーして、クリップボードに準備します。（ファイルとして保存する必要はありません）</li>
            </ol>
            <p><strong>テスト用 Python コード (コピーして使用):</strong></p>
            <details style="margin-top: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                <summary style="cursor: pointer; font-weight: bold; padding: 10px 15px; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                    コードを表示/非表示 (クリックして展開/折りたたみ)
                </summary>
                <pre><code id="test-code-block-mac" class="command" style="white-space: pre-wrap; word-wrap: break-word; max-height: 450px; overflow-y: auto; display: block; padding: 15px; background-color: #212529; color: #f8f9fa; border-radius: 0 0 4px 4px; margin-top: 0;">
# Copyright 1996-2024 Cyberbotics Ltd.
# ... (license details) ...

"""
This controller primarily tests if required Python packages
(numpy, matplotlib, scipy, gymnasium, stable_baselines3, torch)
are installed and accessible by the Python environment used by Webots.
It incorporates the basic structure of the original 'driver' example
but focuses on the import checks first.
"""

# --- Add these import statements to test your environment ---
print("--- Starting Check: Importing Required Packages ---")
import sys  # Needed for sys.exit() on failure

all_imports_successful = True # Flag to track success

try:
    import numpy as np
    print("[ OK ] Successfully imported numpy")
    # Optional basic check:
    # _ = np.array([1, 2])
    # print("[ OK ] numpy basic functionality check passed")

    # Import matplotlib.pyplot as requested
    import matplotlib.pyplot as plt
    print("[ OK ] Successfully imported matplotlib.pyplot")
    # Note: Using plt functions directly might be complex here,
    # but the import itself tests installation.

    import scipy
    print("[ OK ] Successfully imported scipy")
    # Optional basic check:
    # from scipy import constants
    # _ = constants.pi
    # print("[ OK ] scipy basic functionality check passed")

    import gymnasium as gym
    print("[ OK ] Successfully imported gymnasium")
    # Optional basic check:
    # _ = gym.spaces.Discrete(2)
    # print("[ OK ] gymnasium basic functionality check passed")

    import stable_baselines3
    print("[ OK ] Successfully imported stable_baselines3")
    # Optional basic check:
    # _ = stable_baselines3.A2C
    # print("[ OK ] stable_baselines3 basic functionality check passed")

    import torch
    print("[ OK ] Successfully imported torch")
    # Optional basic check:
    # _ = torch.tensor([1.0, 2.0])
    # print("[ OK ] torch basic functionality check passed")

    print("\n--- Check Complete: All specified packages imported successfully! ---")

except ImportError as e:
    all_imports_successful = False # Mark failure
    print(f"\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
    print(f"[FAIL] FAILED TO IMPORT A REQUIRED PACKAGE: {e}")
    print(f"       Error Type: {type(e)}")
    # e.name often holds the name of the failed module
    module_name = getattr(e, 'name', 'Unknown')
    print(f"       Failed Module: '{module_name}'")
    print(f"       -> Check if '{module_name}' is installed in the Python environment")
    print(f"          that Webots is configured to use (control_lab).")
    print(f"       -> CRITICAL (macOS): Did you launch Webots FROM THE TERMINAL")
    print(f"          AFTER running 'conda activate control_lab'?")
    print(f"       -> Verify Path: Webots > Preferences > Python command (should match 'which python' in activated env)")
    print(f"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n")
    # Exit the controller script if an import fails - prevents running Supervisor code
    sys.exit(f"ImportError: Required package '{module_name}' not found or import failed.")
# --- End of added import test section ---


# --- Original Webots example script structure (optional, runs only if imports succeed) ---
# --- This part might produce warnings if the world doesn't match the example exactly ---
if all_imports_successful:
    print("\n[INFO] Imports successful, proceeding with Supervisor initialization (if applicable).")
    from controller import Supervisor
    # Make sure 'common.py' exists if you are using the original example structure, otherwise define dummy
    try:
        # This specific example might not need common.py, adjust if needed
        pass # from common import common_print
    except ImportError:
        # Define a dummy function if needed
        # def common_print(msg): print(f"Dummy common_print: {msg}")
        print("[WARN] 'common.py' not found or not needed for this basic test.")


    class Driver (Supervisor):
        timeStep = 128 # Or get from world basicTimeStep

        def __init__(self):
            super(Driver, self).__init__()
            self.keyboard = None # Initialize to None
            # Use world timestep if available, otherwise default
            try:
                self.timeStep = int(self.getBasicTimeStep())
            except: # Fallback if getBasicTimeStep fails for some reason
                print("[WARN] Could not get basicTimeStep from world, using default.")
                self.timeStep = 128

            # Safely try to get keyboard (may not exist)
            try:
                self.keyboard = self.getKeyboard() # Get keyboard device
                if self.keyboard: # Check if keyboard was found
                    self.keyboard.enable(self.timeStep) # Enable keyboard reading
                    print("[INFO] Keyboard enabled for optional interaction.")
                else:
                    print("[WARN] Keyboard device not found in this world.")

            except Exception as e:
                print(f"[WARN] Could not initialize keyboard device: {e}")

        def run(self):
            print("[INFO] Controller 'run' method started.")
            print("[INFO] Primary goal (import tests) already passed.")
            print("[INFO] This controller will now run passively.")
            if self.keyboard:
                print("[INFO] You can press keys (if defined below) but main focus was imports.")
            # Passive loop to keep controller alive and show simulation running
            while self.step(self.timeStep) != -1:
                # Optionally add key checks here if needed for further testing
                # k = self.keyboard.getKey() if self.keyboard else -1
                # if k == ord('I'): print("Info key pressed")
                pass # Just keep stepping

            print("[INFO] Driver run loop finished or simulation stopped.")

    # --- Script execution ---
    if all_imports_successful:
        print("[INFO] Initializing Driver controller...")
        controller = Driver()
        print("[INFO] Starting controller run loop (passive)...")
        controller.run()
        print("[INFO] Controller run loop exited.")
    else:
        print("[INFO] Script halted due to import errors. Supervisor code was not executed.")

else:
     print("[INFO] Script halted before Supervisor initialization due to import errors.")
</code></pre>
            </details>
        </div>

        <div class="step task">
            <strong>Step 2: Webots でテストを実行する (macOS版)</strong>
            <ol>
                <li><strong>【重要】</strong><a href="#webots-python-config">セクション4</a>で説明した通り、**ターミナル** を開きます。</li>
                <li>ターミナルで <span class="code">control_lab</span> 環境を有効化します:
                    <code class="command">conda activate control_lab</code>
                </li>
                <li>**同じターミナルウィンドウで**、Webots を起動します:
                    <code class="command">/Applications/Webots.app/Contents/MacOS/webots</code>
                    <span class="note">(エイリアス等を設定済みの場合は、そのコマンドで起動)</span>
                </li>
                <li>Webots が起動したら、メニューから <code class="code">File</code> -> <code class="code">Open Sample World...</code> を選択します。</li>
                <li>表示されるウィンドウで、フォルダを次のように辿って <code class="code">examples.wbt</code> を選択し、開きます:
                    <ul>
                        <li><code class="code">languages</code> &#x25B6; <code class="code">python</code> &#x25B6; <code class="code">examples.wbt</code></li>
                    </ul>
                    <span class="note">(このワールドには、Python コントローラーの基本的な使用例が含まれています。)</span>
                </li>
                <li>ワールドがロードされると、ウィンドウ右側にテキストエディタが表示され、<code class="code">driver.py</code> の内容が自動的に開かれます。</li>
                <li>テキストエディタ内で以下の操作を行います:
                    <ul>
                        <li>エディタ内の既存のコードを全て選択します (Cmd+A またはマウスでドラッグ)。</li>
                        <li><strong>Step 1 でコピーしたテスト用 Python コードをエディタ内に貼り付けます (Cmd+V)。</strong></li>
                        <li>Save Text File、Cmd+S キーを押します。</li>
                    </ul>
                </li>
                <li>Webots の上部にリロードを促すメッセージが表示されたら、「Reload」ボタンまたは回転矢印アイコンをクリックします。(保存後に自動でリロードされる場合もあります)</li>
                <li>シミュレーション実行ボタン (▶ アイコン) をクリックして、シミュレーションを開始します。</li>
            </ol>
        </div>

        <div class="step task">
            <strong>Step 3: Webots コンソールの出力を確認する</strong>
            <ol>
                <li>シミュレーションが開始されると、Webots ウィンドウの下部にあるコンソール（Console）にメッセージが出力されます。</li>
                <li class="confirmation"><strong>【成功の場合】</strong> 以下のように、テストコード内で指定した全てのライブラリについて <code class="code">[ OK ] Successfully imported ...</code> というメッセージが表示され、最後に <code class="code">--- Check Complete: All specified packages imported successfully! ---</code> が表示されていれば、連携は成功です！
                    <pre><code class="command" style="font-size: 0.9em;">--- Starting Check: Importing Required Packages ---
[ OK ] Successfully imported numpy
[ OK ] Successfully imported matplotlib.pyplot
[ OK ] Successfully imported scipy
[ OK ] Successfully imported gymnasium
[ OK ] Successfully imported stable_baselines3
[ OK ] Successfully imported torch

--- Check Complete: All specified packages imported successfully! ---

[INFO] Imports successful, proceeding with Supervisor initialization (if applicable).
... (以降のINFO/WARNメッセージ) ...
</code></pre>
                </li>
                <!-- <li class="troubleshooting"><strong>【失敗の場合】</strong> もし <code class="code">[FAIL] FAILED TO IMPORT A REQUIRED PACKAGE: ...</code> というエラーメッセージが表示された場合、そのライブラリの import に失敗しています。エラーメッセージに表示されている `Failed Module: 'xxx'` を確認します。
                    <ul>
                        <li><strong>対処法 (macOS):</strong>
                            <ul>
                                <li><strong>最優先確認:</strong> Webots を**ターミナルから** ( <code class="code">conda activate control_lab</code> の後に) 起動しましたか？これが macOS で最も一般的な原因です。Webots を一度終了し、Step 2 の起動手順を再確認してください。</li>
                                <li><a href="#webots-python-config">セクション4</a>に戻り、Webots の Preferences で設定した Python のパスが、ターミナルで <code class="code">conda activate control_lab</code> を実行後、<code class="code">which python</code> で表示されるパスと一致しているか再確認します。（ターミナルからの起動が前提ですが、パス設定も正しい方が確実です）</li>
                                <li><a href="#pip-install">セクション2</a> (パッケージインストール) に戻り、ターミナルで <code class="code">conda activate control_lab</code> を実行した後、エラーになったパッケージ（例: `pip install torch` や `conda install scipy` など）が正しくインストールされているか確認、または再インストールしてみます (<code class="code">conda list パッケージ名</code> や <code class="code">pip show パッケージ名</code> で確認後、必要なら再インストール)。</li>
                            </ul>
                        </li>
                    </ul>
                </li> -->
            </ol>
        </div>

        <div class="confirmation">
            <strong>【最終確認完了】</strong> コンソールで全てのパッケージが <code class="code">[ OK ]</code> となり、<code class="code">[FAIL]</code> が表示されなければ、Webots と <code class="code">control_lab</code> Python 環境の連携設定（特にターミナルからの起動方法）は正しく完了しており、必要なライブラリも Webots から利用可能です！これで実験を進める準備が整いました。
        </div>
    </div>
    <div class="section" id="next-steps">
        <h3>7. 次のステップ</h3>
        <p>環境構築が完了したら、教員の指示に従い、指定された実験用プロジェクトファイル（Webots ワールドファイル、Python スクリプト等）をダウンロードまたは取得し、各回の実験手順に進んでください。</p>
        <p class="warning">もし環境構築や Webots との連携（特にmacOSでのターミナル起動）で問題が発生した場合は、遠慮なく教員またはティーチングアシスタント (TA) に質問してください。</p>
    </div>

</div> </body>
</html>